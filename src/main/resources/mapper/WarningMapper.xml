<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.hust.ewsystem.mapper.WarningMapper">

    <resultMap id="standPointMap" type="com.hust.ewsystem.DAO.VO.StandPointVO">
        <result property="modelType" column="model_type"/>
        <collection property="points" ofType="com.hust.ewsystem.DAO.PO.StandPoint">
        </collection>
    </resultMap>

    <select id="getStandPointByWarningId" resultMap = "standPointMap">
        SELECT sp.*,m.model_type
        FROM warnings w
        JOIN models m ON w.model_id = m.model_id
        JOIN algorithms a ON m.algorithm_id = a.algorithm_id
        JOIN algorithm_stand_relate asr ON a.algorithm_id = asr.algorithm_id
        JOIN stand_point sp ON asr.stand_point_id = sp.stand_point_id
        where w.warning_id = #{warningId}
    </select>

    <select id="getDeviceByWarningIdList" resultType="com.hust.ewsystem.DAO.DTO.DeviceDTO">
        SELECT DISTINCT device_id AS deviceId,device_type AS deviceType
        FROM warnings w
        LEFT JOIN models m ON w.model_id = m.model_id
        WHERE w.warning_id IN
        <foreach item="warningId" index="index" collection="records" open="(" separator="," close=")">
            #{warningId}
        </foreach>
    </select>

    <select id="getWarningsCount" resultType="int">
        select COUNT(0) AS warning_count
        from warnings w left join models m on w.model_id = m.model_id
        where m.device_id = #{param.deviceId} and m.model_type = #{param.deviceType} and w.model_id = #{param.modelId} and w.warning_level =#{param.warningLevel} and w.warning_status IN (0,1,3)
        <if test="param.startTime != null">
            AND w.start_time &gt;= #{param.startTime}
        </if>
        <if test="param.endTime != null">
            AND w.end_time &lt;= #{param.endTime}
        </if>
    </select>

    <select id="getCount" resultType="com.hust.ewsystem.DAO.DTO.WarnStatusDTO">
        SELECT
        COUNT(CASE WHEN w.warning_status = 0 AND w.warning_level = 1 THEN 1 ELSE NULL END) AS warningLevel1waitDone,
        COUNT(CASE WHEN w.warning_status = 0 AND w.warning_level = 2 THEN 1 ELSE NULL END) AS warningLevel2waitDone,
        COUNT(CASE WHEN w.warning_status = 1 AND w.warning_level = 1 THEN 1 ELSE NULL END) AS warningLevel1waitHangUp,
        COUNT(CASE WHEN w.warning_status = 1 AND w.warning_level = 2 THEN 1 ELSE NULL END) AS warningLevel2waitHangUp,
        COUNT(CASE WHEN w.warning_status = 3 AND w.warning_level = 1 THEN 1 ELSE NULL END) AS warningLevel1waitCloseWait,
        COUNT(CASE WHEN w.warning_status = 3 AND w.warning_level = 2 THEN 1 ELSE NULL END) AS warningLevel2waitCloseWait
        FROM warnings w where model_id = #{modelId}
        <if test="startTime != null">
            AND w.start_time &gt;= #{startTime}
        </if>
        <if test="endTime != null">
            AND w.end_time &lt;= #{endTime}
        </if>
    </select>
</mapper>